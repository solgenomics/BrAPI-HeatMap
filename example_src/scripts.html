<script src="leaflet.js"></script>
<script src="L.CanvasLayer.js"></script>
<script src="d3.js"></script>
<script src="turf.js"></script>
<script src="BrAPI.js"></script>
<script src="BrAPIHeatMap.js" charset="utf-8"></script>
<script type="text/javascript">
    var myHeatMap;
    d3.select("#build-heatmap-submit").on("click",()=>{
        d3.event.stopPropagation()
        d3.select("#map").html("");
        d3.select("#map_controls").html("");
        if(myHeatMap) myHeatMap.map.remove();
        myHeatMap = new BrAPIHeatMap("#map",
            d3.select('[name="endpoint"]').node().value,
            d3.select('[name="studyDbId"]').node().value,
            {
                defaultPos:[3.9021624,7.5051418],
                observationLevel:d3.select("#level_select").node().value,
                draw_controls:true,
                draw_control_trait:true,
                draw_control_unit:true,
                draw_control_rep:true,
                draw_control_block:true,
                // showNames:false,
                defaultPlotWidth: 0.002,
        });
        console.log("yellow");
        L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
            attribution: '&copy; <a href="http://www.esri.com/">Esri</a>, DigitalGlobe, GeoEye, i-cubed, USDA FSA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community',
            maxZoom: 28,
            maxNativeZoom: 19
        }).addTo(myHeatMap.map);
        
        let trait_select = () => myHeatMap.getTraits().then(traits=>{
            d3.select("#trait_select").select("option[disabled]").attr("selected",'');
            let opts = d3.select("#trait_select").selectAll("option:not([disabled])")
                .data(traits);
            opts.exit().remove();
            opts.enter().append("option")
                .merge(opts)
                .text(t=>t.name)
                .attr("selected",null)
                .attr("value",t=>t.id);
            d3.select("#trait_select").on("change",null).on("change",function(){
                myHeatMap.setTrait(d3.select("#trait_select").node().value);
            })
        });
        
        trait_select()
        d3.select("#level_select").on("change",null).on("change",function(){
            myHeatMap.setLevel(d3.select("#level_select").node().value);
            trait_select();
        })
        
        return false;
    });
</script>
